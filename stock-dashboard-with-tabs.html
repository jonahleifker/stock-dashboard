<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useMemo } = React;

        const App = () => {
            const [tab, setTab] = useState('pullbacks');
            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white border-b sticky top-0 z-10 shadow">
                        <div className="max-w-7xl mx-auto px-8 flex space-x-8">
                            <button onClick={() => setTab('pullbacks')} className={`py-4 px-1 border-b-2 font-medium ${tab === 'pullbacks' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500'}`}>
                                ðŸ“‰ Pullbacks
                            </button>
                            <button onClick={() => setTab('sectors')} className={`py-4 px-1 border-b-2 font-medium ${tab === 'sectors' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500'}`}>
                                ðŸ”¥ Hot Sectors
                            </button>
                        </div>
                    </div>
                    <div className="p-8">{tab === 'pullbacks' ? <Pullbacks /> : <Sectors />}</div>
                </div>
            );
        };

        const Pullbacks = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState(false);
            
            const fetch = async () => {
                setLoading(true);
                try {
                    const res = await window.fetch('http://localhost:8000/api/stocks');
                    setData(await res.json());
                } catch (e) {}
                setLoading(false);
            };

            const stocks = useMemo(() => {
                let result = data.map(s => ({...s, change: ((s.currentPrice - s.highLast30Days) / s.highLast30Days) * 100}))
                    .filter(s => s.ticker.toLowerCase().includes(search.toLowerCase()));
                if (filter) result = result.filter(s => s.change <= -10);
                return result.sort((a,b) => a.change - b.change);
            }, [data, search, filter]);

            return (
                <div className="max-w-7xl mx-auto">
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                        <div className="flex justify-between mb-6">
                            <div><h1 className="text-3xl font-bold">Pullback Opportunities</h1></div>
                            <button onClick={fetch} disabled={loading} className="px-5 py-2 bg-blue-600 text-white rounded-lg">
                                {loading ? 'Loading...' : 'Refresh'}
                            </button>
                        </div>
                        {data.length > 0 && (
                            <>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                        <div className="text-red-600 text-sm font-medium">Opportunities (â‰¥10% down)</div>
                                        <div className="text-3xl font-bold text-red-700">{stocks.filter(s => s.change <= -10).length}</div>
                                    </div>
                                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <div className="text-gray-600 text-sm font-medium">Total Stocks</div>
                                        <div className="text-3xl font-bold text-gray-700">{stocks.length}</div>
                                    </div>
                                </div>
                                <div className="flex gap-3 mb-6">
                                    <input type="text" placeholder="Search..." className="flex-1 px-4 py-2 border rounded-lg" value={search} onChange={e => setSearch(e.target.value)} />
                                    <button onClick={() => setFilter(!filter)} className={`px-5 py-2 rounded-lg font-medium ${filter ? 'bg-red-600 text-white' : 'bg-white border'}`}>
                                        {filter ? 'Show All' : 'Opportunities Only'}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                    {data.length > 0 && (
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Ticker</th>
                                        <th className="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Company</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">Current</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">30d High</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">% from High</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {stocks.map(s => (
                                        <tr key={s.ticker} className="hover:bg-gray-50">
                                            <td className="px-6 py-4"><div className="font-bold">{s.ticker}</div></td>
                                            <td className="px-6 py-4"><div className="text-sm">{s.company}</div></td>
                                            <td className="px-6 py-4 text-right"><div className="text-sm font-bold">${s.currentPrice.toFixed(2)}</div></td>
                                            <td className="px-6 py-4 text-right"><div className="text-sm">${s.highLast30Days.toFixed(2)}</div></td>
                                            <td className="px-6 py-4 text-right">
                                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${s.change <= -10 ? 'bg-red-600 text-white' : 'bg-red-50 text-red-800'}`}>
                                                    {s.change.toFixed(2)}%
                                                    {s.change <= -10 && ' ðŸŽ¯'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const Sectors = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [timeframe, setTimeframe] = useState('30d');
            const [expanded, setExpanded] = useState(null);
            
            const fetch = async () => {
                setLoading(true);
                try {
                    const res = await window.fetch('http://localhost:8000/api/sectors');
                    setData(await res.json());
                } catch (e) {}
                setLoading(false);
            };

            const sorted = useMemo(() => {
                return [...data].sort((a,b) => {
                    const aVal = timeframe === '7d' ? a.avg_change_7d : timeframe === '30d' ? a.avg_change_30d : a.avg_change_90d;
                    const bVal = timeframe === '7d' ? b.avg_change_7d : timeframe === '30d' ? b.avg_change_30d : b.avg_change_90d;
                    return bVal - aVal;
                });
            }, [data, timeframe]);

            const getChange = (s) => timeframe === '7d' ? s.avg_change_7d : timeframe === '30d' ? s.avg_change_30d : s.avg_change_90d;

            return (
                <div className="max-w-7xl mx-auto">
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                        <div className="flex justify-between mb-6">
                            <div><h1 className="text-3xl font-bold">Hot Sectors Analysis</h1></div>
                            <button onClick={fetch} disabled={loading} className="px-5 py-2 bg-blue-600 text-white rounded-lg">
                                {loading ? 'Loading... (3-5 min)' : 'Refresh'}
                            </button>
                        </div>
                        {loading && <div className="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4"><p className="text-sm text-blue-700">Analyzing 200+ stocks... This takes 3-5 minutes.</p></div>}
                        {data.length > 0 && (
                            <>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                        <div className="text-green-600 text-sm font-medium">Top Sector</div>
                                        <div className="text-2xl font-bold text-green-700">{sorted[0]?.sector}</div>
                                        <div className="text-xs text-green-600">+{getChange(sorted[0])}%</div>
                                    </div>
                                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <div className="text-gray-600 text-sm font-medium">Sectors Tracked</div>
                                        <div className="text-3xl font-bold text-gray-700">{data.length}</div>
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div className="text-blue-600 text-sm font-medium">Stocks Analyzed</div>
                                        <div className="text-3xl font-bold text-blue-700">{data.reduce((s,d) => s + d.stock_count, 0)}</div>
                                    </div>
                                </div>
                                <div className="flex gap-3 mb-6">
                                    {['7d', '30d', '90d'].map(t => (
                                        <button key={t} onClick={() => setTimeframe(t)} className={`px-5 py-2 rounded-lg font-medium ${timeframe === t ? 'bg-blue-600 text-white' : 'bg-white border'}`}>
                                            {t === '7d' ? '1 Week' : t === '30d' ? '1 Month' : '3 Months'}
                                        </button>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                    {data.length > 0 && (
                        <div className="space-y-4">
                            {sorted.map((sector, i) => (
                                <div key={sector.sector} className="bg-white rounded-lg shadow">
                                    <div className="p-6 cursor-pointer hover:bg-gray-50" onClick={() => setExpanded(expanded === sector.sector ? null : sector.sector)}>
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-4">
                                                <div className="text-2xl font-bold text-gray-400">#{i + 1}</div>
                                                <div>
                                                    <h3 className="text-xl font-bold">{sector.sector}</h3>
                                                    <p className="text-sm text-gray-500">{sector.stock_count} stocks</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className={`px-4 py-2 rounded-full text-lg font-bold ${getChange(sector) >= 5 ? 'bg-green-600 text-white' : getChange(sector) > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                                    {getChange(sector) > 0 ? '+' : ''}{getChange(sector)}%
                                                </span>
                                                <div className="text-gray-400">{expanded === sector.sector ? 'â–¼' : 'â–¶'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    {expanded === sector.sector && (
                                        <div className="border-t p-6 bg-gray-50">
                                            <h4 className="font-bold mb-4">Top Performers</h4>
                                            <div className="space-y-2">
                                                {sector.top_stocks.map(stock => {
                                                    const change = timeframe === '7d' ? stock.change_7d : timeframe === '30d' ? stock.change_30d : stock.change_90d;
                                                    return (
                                                        <div key={stock.ticker} className="flex justify-between p-3 bg-white rounded-lg">
                                                            <div className="flex items-center gap-3">
                                                                <div className="font-bold">{stock.ticker}</div>
                                                                <div className="text-sm text-gray-600">{stock.company}</div>
                                                            </div>
                                                            <div className="flex items-center gap-4">
                                                                <div className="text-sm font-medium">${stock.currentPrice.toFixed(2)}</div>
                                                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${change >= 10 ? 'bg-green-600 text-white' : change > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                    {change > 0 ? '+' : ''}{change?.toFixed(2)}%
                                                                </span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>